name: guix

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/guix.yml'
  
jobs:
  guix:
    runs-on: ubuntu-latest
    steps:
      - run: |
          sudo apt install -y expect
          curl -fsSL "https://git.savannah.gnu.org/gitweb/?p=guix.git;a=blob_plain;f=etc/guix-install.sh;hb=HEAD" > guix.sh
          chmod +x guix.sh
          sudo expect -c "spawn ./guix.sh; expect return; send \r; expect \[Y\/n\]; send Y\r; expect \[Y\/n\]; send Y\r; expect \[Y\/n\]; send Y\r; expect \[Y\/n\]; send Y\r; expect \[Y\/n\]; send Y\r; interact"
          guix install glibc-locales
          export GUIX_LOCPATH="$HOME/.guix-profile/lib/locale"
          
          mkdir -p ~/.config/guix
          cat > ~/.config/guix/channels.scm <<EOF
          (cons* (channel
                  (name 'nonguix)
                  (url "https://gitlab.com/nonguix/nonguix")
                  ;; Enable signature verification:
                  (introduction
                   (make-channel-introduction
                    "897c1a470da759236cc11798f4e0a5f7d4d59fbc"
                    (openpgp-fingerprint
                     "2A39 3FFF 68F4 EF7A 3D29  12AF 6F51 20A0 22FB B2D5"))))
                 %default-channels)
          EOF
          guix pull
          git clone https://gitlab.com/nonguix/nonguix
          cd nonguix
          guix system image --image-type=iso9660 nongnu/system/install.scm
          ls -al
